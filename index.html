<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kho L·ªëp Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f7f8fa;
    --white: #ffffff;
    --border: #e8eaed;
    --text: #1a1d23;
    --muted: #8b919e;
    --accent: #2563eb;
    --accent-light: #eff4ff;
    --green: #16a34a;
    --green-light: #f0fdf4;
    --red: #dc2626;
    --red-light: #fef2f2;
    --orange: #ea580c;
    --orange-light: #fff7ed;
    --radius: 12px;
    --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
    --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'Plus Jakarta Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    font-size: 14px;
  }

  .topbar {
    background: var(--white);
    border-bottom: 1px solid var(--border);
    padding: 0 32px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
  }
  
  .brand {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: 700;
    font-size: 15px;
    color: var(--text);
    letter-spacing: -0.3px;
  }
  
  .brand-dot {
    width: 28px; height: 28px;
    background: var(--accent);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 15px;
  }
  
  .topbar-stats {
    display: flex;
    gap: 24px;
    align-items: center;
  }
  
  .ts {
    text-align: right;
  }
  
  .ts-label { font-size: 11px; color: var(--muted); font-weight: 500; letter-spacing: 0.3px; }
  .ts-value { font-size: 14px; font-weight: 700; color: var(--text); }
  .ts-value.blue { color: var(--accent); }
  .ts-value.green { color: var(--green); }
  
  .divider-v {
    width: 1px;
    height: 28px;
    background: var(--border);
  }
  
  .sync-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 11px;
    font-weight: 600;
    background: var(--green-light);
    color: var(--green);
  }
  
  .sync-badge.loading {
    background: #fef3c7;
    color: #ca8a04;
  }
  
  .sync-badge .dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: currentColor;
    animation: pulse 1.5s infinite;
  }
  
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  .page {
    max-width: 1200px;
    margin: 0 auto;
    padding: 28px 24px;
    display: grid;
    grid-template-columns: 320px 1fr;
    gap: 20px;
    align-items: start;
  }
  
  @media (max-width: 860px) {
    .page { grid-template-columns: 1fr; padding: 16px; }
  }

  @media (max-width: 600px) {
    body {
      font-size: 16px;
    }
    .page {
      padding: 10px;
    }
    table {
      font-size: 13px;
    }
    .tire-img,
    .tire-no-img {
      width: 40px;
      height: 40px;
    }
    td {
      padding: 10px 8px;
    }
    .topbar {
      padding: 0 12px;
    }
    .topbar-stats {
      gap: 12px;
    }
  }

  .card {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }
  
  .card-header {
    padding: 18px 20px 0;
    font-size: 12px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1.2px;
    color: var(--muted);
    margin-bottom: 16px;
  }
  
  .card-body { padding: 20px; }

  .field { margin-bottom: 12px; }
  
  .field label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--muted);
    margin-bottom: 5px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .field input[type="text"],
  .field input[type="number"],
  .field input[type="file"] {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    padding: 9px 12px;
    border-radius: 8px;
    outline: none;
    transition: border-color 0.15s, box-shadow 0.15s;
  }
  
  .field input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(37,99,235,0.08);
    background: var(--white);
  }
  
  .field input::placeholder { color: #c5c9d1; font-weight: 400; }

  .upload-zone {
    border: 1.5px dashed var(--border);
    border-radius: 8px;
    padding: 12px;
    text-align: center;
    cursor: pointer;
    transition: all 0.15s;
    position: relative;
    background: var(--bg);
  }
  
  .upload-zone:hover {
    border-color: var(--accent);
    background: var(--accent-light);
  }
  
  .upload-zone input {
    position: absolute; inset: 0; opacity: 0; cursor: pointer; width: 100%; height: 100%;
  }
  
  .upload-text { font-size: 12px; color: var(--muted); font-weight: 500; }
  .preview-img {
    width: 100%; height: 100px; object-fit: cover;
    border-radius: 6px; display: none; margin-bottom: 6px;
    cursor: pointer;
  }

  .btn-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px;
    margin-bottom: 12px;
  }

  .btn-group button {
    padding: 9px;
    border: 1px solid var(--border);
    background: var(--white);
    border-radius: 8px;
    cursor: pointer;
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 13px;
    font-weight: 600;
    transition: all 0.15s;
    color: var(--text);
  }

  .btn-group button:hover {
    background: var(--accent);
    color: white;
    border-color: var(--accent);
  }

  .btn-primary {
    width: 100%;
    padding: 11px;
    background: var(--accent);
    border: none;
    border-radius: 8px;
    color: white;
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    margin-top: 4px;
    letter-spacing: 0.2px;
  }
  
  .btn-primary:hover { background: #1d4ed8; box-shadow: 0 4px 12px rgba(37,99,235,0.25); }
  .btn-primary:active { transform: scale(0.99); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

  .btn-secondary {
    width: 100%;
    padding: 10px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.15s;
    margin-top: 8px;
    letter-spacing: 0.2px;
  }
  
  .btn-secondary:hover { background: var(--border); }

  .search-wrap {
    position: relative;
    margin-bottom: 12px;
  }
  
  .search-wrap input {
    width: 100%;
    background: var(--white);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'Plus Jakarta Sans', sans-serif;
    font-size: 14px;
    font-weight: 500;
    padding: 10px 14px 10px 38px;
    border-radius: 8px;
    outline: none;
    transition: border-color 0.15s;
    box-shadow: var(--shadow);
  }
  
  .search-wrap input:focus { border-color: var(--accent); }
  .search-wrap .s-icon {
    position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
    color: var(--muted); font-size: 15px; pointer-events: none;
  }

  table { width: 100%; border-collapse: collapse; }
  
  thead th {
    padding: 11px 16px;
    font-size: 11px;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    color: var(--muted);
    border-bottom: 1px solid var(--border);
    text-align: left;
    background: var(--bg);
  }
  
  thead th:last-child { text-align: center; }

  tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.1s;
  }
  
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: #fafbfc; }

  td {
    padding: 12px 16px;
    vertical-align: middle;
  }
  
  td:last-child { text-align: center; }

  .tire-img {
    width: 44px; height: 44px;
    object-fit: cover;
    border-radius: 8px;
    border: 1px solid var(--border);
    cursor: pointer;
  }
  
  .tire-no-img {
    width: 44px; height: 44px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    font-size: 20px;
    color: var(--muted);
  }
  
  .tire-name { font-weight: 600; font-size: 14px; color: var(--text); }

  .price-buy { color: var(--muted); font-size: 13px; font-weight: 500; }
  .price-sell { color: var(--accent); font-weight: 600; font-size: 14px; }

  .badge {
    display: inline-flex;
    align-items: center;
    gap: 4px;
    padding: 3px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
  }
  
  .badge-ok { background: var(--green-light); color: var(--green); }
  .badge-low { background: var(--red-light); color: var(--red); }

  .actions { display: flex; gap: 4px; justify-content: center; flex-wrap: wrap; }
  
  .btn-icon {
    width: 30px; height: 30px;
    border: 1px solid var(--border);
    border-radius: 7px;
    cursor: pointer;
    font-size: 13px;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.12s;
    background: var(--white);
    color: var(--muted);
    font-weight: 700;
    padding: 0;
  }
  
  .btn-icon:hover { border-color: transparent; color: white; transform: scale(1.05); }
  .btn-add:hover { background: var(--green); }
  .btn-edit:hover { background: var(--accent); }
  .btn-minus:hover { background: var(--orange); }
  .btn-del:hover { background: var(--red); }

  .empty {
    padding: 50px 20px;
    text-align: center;
    color: var(--muted);
  }
  
  .empty-icon { font-size: 36px; margin-bottom: 10px; opacity: 0.4; }
  .empty p { font-size: 13px; line-height: 1.6; }

  .footer-bar {
    background: var(--white);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 16px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: var(--shadow);
    flex-wrap: wrap;
    gap: 12px;
    margin-top: 12px;
  }
  
  .footer-item .fl { font-size: 11px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px; }
  .footer-item .fv { font-size: 18px; font-weight: 700; color: var(--text); }
  .footer-item .fv.blue { color: var(--accent); }
  .footer-item .fv.green { color: var(--green); }

  .toast {
    position: fixed;
    bottom: 24px; right: 24px;
    background: var(--text);
    color: white;
    padding: 10px 18px;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 500;
    box-shadow: var(--shadow-md);
    transform: translateY(60px);
    opacity: 0;
    transition: all 0.25s cubic-bezier(.34,1.4,.64,1);
    z-index: 999;
  }
  
  .toast.show { transform: translateY(0); opacity: 1; }

  @keyframes rowIn {
    from { opacity: 0; transform: translateY(6px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  
  tbody tr { animation: rowIn 0.2s ease; }
  
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    justify-content: center;
    align-items: center;
    overflow-y: auto;
  }

  .modal-content {
    background: white;
    padding: 24px;
    border-radius: 12px;
    width: 90vw;
    max-width: 400px;
    box-shadow: var(--shadow-md);
    animation: slideUp 0.3s ease;
    margin: auto;
  }

  @keyframes slideUp {
    from { transform: translateY(20px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .modal-header {
    font-size: 16px;
    font-weight: 700;
    margin-bottom: 20px;
    color: var(--text);
    position: relative;
  }

  .modal-close {
    position: absolute;
    top: -30px;
    right: 0;
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: white;
  }

  .image-preview {
    width: 100%;
    height: 150px;
    border-radius: 8px;
    object-fit: cover;
    margin-bottom: 12px;
    display: none;
    cursor: pointer;
  }

  .img-modal {
    display: none;
    position: fixed;
    z-index: 999;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    justify-content: center;
    align-items: center;
  }

  .img-modal-content {
    width: 90vw;
    max-width: 400px;
    aspect-ratio: 1 / 1;
    object-fit: cover;
    border-radius: 12px;
    background: #000;
  }
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="brand">
    <div class="brand-dot">üöó</div>
    Qu·∫£n L√Ω Kho L·ªëp
  </div>
  <div class="topbar-stats">
    <div class="ts">
      <div class="ts-label">Lo·∫°i l·ªëp</div>
      <div class="ts-value" id="statTotal">0</div>
    </div>
    <div class="divider-v"></div>
    <div class="ts">
      <div class="ts-label">T·ªïng t·ªìn</div>
      <div class="ts-value" id="statQty">0</div>
    </div>
    <div class="divider-v"></div>
    <div class="ts">
      <div class="ts-label">V·ªën kho</div>
      <div class="ts-value blue" id="statCap">0‚Ç´</div>
    </div>
    <div class="divider-v"></div>
    <div class="ts">
      <div class="ts-label">L·ª£i nhu·∫≠n</div>
      <div class="ts-value green" id="statProfit">0‚Ç´</div>
    </div>
    <div class="divider-v"></div>
    <div class="sync-badge loading" id="syncBadge">
      <span class="dot"></span>
      <span>K·∫øt n·ªëi...</span>
    </div>
  </div>
</div>

<!-- PAGE -->
<div class="page">

  <!-- FORM -->
  <div class="card">
    <div class="card-header">Th√™m l·ªëp m·ªõi</div>
    <div class="card-body">
      <div class="field">
        <label>T√™n l·ªëp</label>
        <input type="text" id="ten" placeholder="VD: Bridgestone 205/55R16">
      </div>
      <div class="field">
        <label>Gi√° nh·∫≠p (‚Ç´)</label>
        <input type="number" id="gianhap" placeholder="0">
      </div>
      <div class="field">
        <label>Gi√° b√°n (‚Ç´)</label>
        <input type="number" id="giaban" placeholder="0">
      </div>
      <div class="field">
        <label>S·ªë l∆∞·ª£ng</label>
        <input type="number" id="ton" placeholder="0" min="0">
      </div>
      <div class="field">
        <label>H√¨nh ·∫£nh</label>
        <div class="btn-group">
          <button onclick="document.getElementById('anhFile').click()">üìÅ Ch·ªçn file</button>
         
        </div>
        <img id="preview" class="preview-img" onclick="xemAnh(this.src)">
        <div id="uploadPlaceholder">
          <div style="font-size:22px;margin-bottom:4px">üì∑</div>
          <div class="upload-text">Ch·ªçn ho·∫∑c ch·ª•p ·∫£nh</div>
        </div>
        <input type="file" id="anhFile" accept="image/*" onchange="chonAnh(event)" style="display:none;">
        <input type="file" id="anhCamera" accept="image/*" capture="environment" onchange="chonAnh(event)" style="display:none;">
      </div>
      <button class="btn-primary" onclick="them()">+ Th√™m v√†o kho</button>
      <button class="btn-secondary" onclick="xuatDuLieu()">‚¨áÔ∏è Xu·∫•t d·ªØ li·ªáu</button>
      <button class="btn-secondary" onclick="document.getElementById('importFile').click()">‚¨ÜÔ∏è Nh·∫≠p d·ªØ li·ªáu</button>
      <input type="file" id="importFile" accept=".json,.csv,.xlsx" onchange="nhapDuLieu(event)" style="display:none;">

    </div>
  </div>

  <!-- RIGHT -->
  <div>
    <div class="search-wrap">
      <span class="s-icon">üîç</span>
      <input type="text" id="search" placeholder="T√¨m ki·∫øm t√™n l·ªëp..." onkeyup="render()">
    </div>

    <div class="card">
      <table>
        <thead>
          <tr>
            <th>·∫¢nh</th>
            <th>T√™n l·ªëp</th>
            <th>Gi√° nh·∫≠p</th>
            <th>Gi√° b√°n</th>
            <th>T·ªìn</th>
            <th>Thao t√°c</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>

    <div class="footer-bar">
      <div class="footer-item">
        <div class="fl">T·ªïng v·ªën t·ªìn kho</div>
        <div class="fv blue" id="tongkho">0‚Ç´</div>
      </div>
      <div class="footer-item">
        <div class="fl">L·ª£i nhu·∫≠n k·ª≥ v·ªçng</div>
        <div class="fv green" id="loinhuan">0‚Ç´</div>
      </div>
    </div>
  </div>

</div>

<!-- Modal Xem ·∫¢nh -->
<div id="imgModal" class="img-modal" onclick="dongImgModal()">
  <img id="modalImg" class="img-modal-content">
</div>

<!-- Modal S·ª≠a L·ªëp -->
<div id="editModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      S·ª≠a th√¥ng tin l·ªëp
      <button class="modal-close" onclick="dongEditModal()">‚úï</button>
    </div>
    
    <div class="field">
      <label>T√™n l·ªëp</label>
      <input type="text" id="editTen" placeholder="T√™n l·ªëp">
    </div>
    <div class="field">
      <label>Gi√° nh·∫≠p (‚Ç´)</label>
      <input type="number" id="editGianhap" placeholder="0">
    </div>
    <div class="field">
      <label>Gi√° b√°n (‚Ç´)</label>
      <input type="number" id="editGiaban" placeholder="0">
    </div>
    <div class="field">
      <label>S·ªë l∆∞·ª£ng</label>
      <input type="number" id="editTon" placeholder="0" min="0">
    </div>

    <div class="field">
      <label>H√¨nh ·∫£nh</label>
      <div class="btn-group">
        <button onclick="document.getElementById('editImageFile').click()">üìÅ Ch·ªçn file</button>
        
      </div>
      <img id="editImagePreview" class="image-preview" onclick="xemAnh(this.src)">
      <div id="editUploadPlaceholder">
        <div style="font-size:18px;margin-bottom:4px">üì∑</div>
        <div class="upload-text">Ch·ªçn ho·∫∑c ch·ª•p ·∫£nh</div>
      </div>
      <input type="file" id="editImageFile" accept="image/*" onchange="chonAnhSua(event)" style="display:none;">
      <input type="file" id="editImageCamera" accept="image/*" capture="environment" onchange="chonAnhSua(event)" style="display:none;">
    </div>

    <button class="btn-primary" onclick="luuSua()">üíæ L∆∞u s·ª≠a</button>
    <button class="btn-secondary" onclick="dongEditModal()">H·ªßy</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
let data = [];
let anhTam = "";
let editingIndex = -1;
let editImageTam = "";
let db = null;
let dbRef = null;

const firebaseConfig = {
  apiKey: "AIzaSyAXX42oWz-AE5H4jl-nV-505s406765ze4",
  authDomain: "quan-li-lop.firebaseapp.com",
  projectId: "quan-li-lop",
  databaseURL: "https://quan-li-lop-default-rtdb.asia-southeast1.firebasedatabase.app",
  appId: "1:616666519319:web:7c6f3b8d8c7c9e9f9f9f9f"
};

try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
  dbRef = db.ref("lopData");
  
  dbRef.on("value", (snapshot) => {
    const fbData = snapshot.val();
    if (fbData) {
      if (Array.isArray(fbData)) {
        data = fbData;
      } else {
        data = Object.values(fbData);
      }
    } else {
      data = [];
    }
    updateSyncStatus(true, "‚úì ƒê√£ k·∫øt n·ªëi");
    render();
  });

  dbRef.on("error", (error) => {
    console.error("Firebase error:", error);
    updateSyncStatus(false, "L·ªói k·∫øt n·ªëi");
  });
} catch(e) {
  console.error("Firebase init error:", e);
  updateSyncStatus(false, "L·ªói Firebase");
  data = JSON.parse(localStorage.getItem("lopData")) || [];
  render();
}

function updateSyncStatus(online, text) {
  const badge = document.getElementById("syncBadge");
  if (online) {
    badge.classList.remove("loading");
    badge.innerHTML = '<span class="dot"></span><span>' + text + '</span>';
  } else {
    badge.classList.add("loading");
    badge.innerHTML = '<span class="dot"></span><span>' + text + '</span>';
  }
}

function save() {
  if (dbRef) {
    dbRef.set(data, (error) => {
      if (error) {
        showToast("‚ö†Ô∏è L·ªói l∆∞u d·ªØ li·ªáu");
        updateSyncStatus(false, "L·ªói l∆∞u");
      } else {
        updateSyncStatus(true, "‚úì ƒê√£ l∆∞u");
      }
    });
  } else {
    localStorage.setItem("lopData", JSON.stringify(data));
  }
}

function showToast(msg) {
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(() => t.classList.remove("show"), 2200);
}

function chonAnh(e) {
  let file = e.target.files[0];
  if (!file) return;
  let reader = new FileReader();
  reader.onload = x => {
    anhTam = x.target.result;
    const p = document.getElementById("preview");
    p.src = anhTam;
    p.style.display = "block";
    document.getElementById("uploadPlaceholder").style.display = "none";
  };
  reader.readAsDataURL(file);
}

function chonAnhSua(e) {
  let file = e.target.files[0];
  if (!file) return;
  let reader = new FileReader();
  reader.onload = x => {
    editImageTam = x.target.result;
    const p = document.getElementById("editImagePreview");
    p.src = editImageTam;
    p.style.display = "block";
    document.getElementById("editUploadPlaceholder").style.display = "none";
  };
  reader.readAsDataURL(file);
}

function them() {
  let ten = document.getElementById("ten").value.trim();
  let gianhap = Number(document.getElementById("gianhap").value);
  let giaban = Number(document.getElementById("giaban").value);
  let ton = Number(document.getElementById("ton").value);
  
  if (!ten) { showToast("‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n l·ªëp"); return; }
  if (!gianhap) { showToast("‚ö†Ô∏è Vui l√≤ng nh·∫≠p gi√° nh·∫≠p"); return; }
  
  data.unshift({ ten, gianhap, giaban, ton, anh: anhTam });
  save();
  
  document.getElementById("ten").value = "";
  document.getElementById("gianhap").value = "";
  document.getElementById("giaban").value = "";
  document.getElementById("ton").value = "";
  document.getElementById("preview").style.display = "none";
  document.getElementById("uploadPlaceholder").style.display = "block";
  document.getElementById("anhFile").value = "";
  document.getElementById("anhCamera").value = "";
  anhTam = "";
  
  showToast("‚úì ƒê√£ th√™m: " + ten);
}

function cong(i) {
  data[i].ton++;
  save();
  render();
}

function tru(i) {
  if (data[i].ton > 0) data[i].ton--;
  save();
  render();
}

function xoa(i) {
  if (confirm("X√≥a l·ªëp \"" + data[i].ten + "\"?")) {
    data.splice(i, 1);
    save();
    showToast("ƒê√£ x√≥a");
  }
}

function moEditModal(i) {
  editingIndex = i;
  editImageTam = "";
  const item = data[i];
  
  document.getElementById("editTen").value = item.ten;
  document.getElementById("editGianhap").value = item.gianhap;
  document.getElementById("editGiaban").value = item.giaban;
  document.getElementById("editTon").value = item.ton;
  
  const preview = document.getElementById("editImagePreview");
  if (item.anh) {
    preview.src = item.anh;
    preview.style.display = "block";
    editImageTam = item.anh;
    document.getElementById("editUploadPlaceholder").style.display = "none";
  } else {
    preview.style.display = "none";
    document.getElementById("editUploadPlaceholder").style.display = "block";
  }
  
  document.getElementById("editModal").style.display = "flex";
}

function dongEditModal() {
  document.getElementById("editModal").style.display = "none";
}

function luuSua() {
  const ten = document.getElementById("editTen").value.trim();
  const gianhap = Number(document.getElementById("editGianhap").value);
  const giaban = Number(document.getElementById("editGiaban").value);
  const ton = Number(document.getElementById("editTon").value);
  
  if (!ten) { showToast("‚ö†Ô∏è Vui l√≤ng nh·∫≠p t√™n l·ªëp"); return; }
  if (!gianhap) { showToast("‚ö†Ô∏è Vui l√≤ng nh·∫≠p gi√° nh·∫≠p"); return; }
  
  data[editingIndex] = {
    ten,
    gianhap,
    giaban,
    ton,
    anh: editImageTam
  };
  
  save();
  dongEditModal();
  showToast("‚úì ƒê√£ c·∫≠p nh·∫≠t: " + ten);
}

function fmt(n) {
  return n.toLocaleString("vi-VN") + "‚Ç´";
}

function render() {
  let html = "", tongVon = 0, tongBan = 0;
  
  let tongVonAll = 0, tongBanAll = 0;
  data.forEach(item => {
    tongVonAll += item.gianhap * item.ton;
    tongBanAll += item.giaban * item.ton;
  });
  
  let kw = document.getElementById("search").value.toLowerCase();

  data.forEach((item, i) => {
    if (!item.ten.toLowerCase().includes(kw)) return;
    tongVon += item.gianhap * item.ton;
    tongBan += item.giaban * item.ton;

    const img = item.anh
      ? `<img src="${item.anh}" class="tire-img" onclick="xemAnh('${item.anh.replace(/'/g, "\\'")}')">`
      : `<div class="tire-no-img">üèéÔ∏è</div>`;

    const badge = item.ton <= 2
      ? `<span class="badge badge-low">${item.ton}</span>`
      : `<span class="badge badge-ok">${item.ton}</span>`;

    html += `<tr>
      <td>${img}</td>
      <td><div class="tire-name">${item.ten}</div></td>
      <td><span class="price-buy">${fmt(item.gianhap)}</span></td>
      <td><span class="price-sell">${fmt(item.giaban)}</span></td>
      <td>${badge}</td>
      <td><div class="actions">
        <button class="btn-icon btn-add" onclick="cong(${i})" title="Th√™m">Ôºã</button>
        <button class="btn-icon btn-edit" onclick="moEditModal(${i})" title="S·ª≠a">‚úèÔ∏è</button>
        <button class="btn-icon btn-minus" onclick="tru(${i})" title="Tr·ª´">Ôºç</button>
        <button class="btn-icon btn-del" onclick="xoa(${i})" title="X√≥a">‚úï</button>
      </div></td>
    </tr>`;
  });

  if (!html) {
    html = `<tr><td colspan="6"><div class="empty">
      <div class="empty-icon">üèÅ</div>
      <p>Ch∆∞a c√≥ l·ªëp n√†o trong kho<br>H√£y th√™m l·ªëp m·ªõi b√™n tr√°i!</p>
    </div></td></tr>`;
  }

  document.getElementById("tableBody").innerHTML = html;
  document.getElementById("tongkho").textContent = fmt(tongVon);
  document.getElementById("loinhuan").textContent = fmt(tongBan - tongVon);
  document.getElementById("statTotal").textContent = data.length;
  document.getElementById("statQty").textContent = data.reduce((sum, item) => sum + item.ton, 0);
  document.getElementById("statCap").textContent = tongVonAll >= 1e6 ? (tongVonAll/1e6).toFixed(1)+"M‚Ç´" : fmt(tongVonAll);
  document.getElementById("statProfit").textContent = (tongBanAll-tongVonAll) >= 1e6 ? ((tongBanAll-tongVonAll)/1e6).toFixed(1)+"M‚Ç´" : fmt(tongBanAll-tongVonAll);
}

function xuatDuLieu() {
  const jsonStr = JSON.stringify(data, null, 2);
  const blob = new Blob([jsonStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `kho-lop-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(url);
  showToast("‚úì ƒê√£ xu·∫•t d·ªØ li·ªáu");
}

function nhapDuLieu(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  const fileName = file.name.toLowerCase();

  reader.onload = function(e) {
    try {
      let importedData = [];

      // JSON
      if (fileName.endsWith(".json")) {
        importedData = JSON.parse(e.target.result);
      }

      // CSV
      else if (fileName.endsWith(".csv")) {
        const text = e.target.result;
        const rows = text.split("\n").slice(1); // b·ªè d√≤ng ti√™u ƒë·ªÅ
        rows.forEach(row => {
          const cols = row.split(",");
          if (cols.length >= 4) {
            importedData.push({
              ten: cols[0]?.trim(),
              gianhap: Number(cols[1]),
              giaban: Number(cols[2]),
              ton: Number(cols[3]),
              anh: ""
            });
          }
        });
      }

      // Excel
      else if (fileName.endsWith(".xlsx")) {
        const workbook = XLSX.read(e.target.result, { type: "binary" });
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet);

        jsonData.forEach(row => {
          importedData.push({
            ten: row.ten || row.Ten || row["T√™n l·ªëp"] || "",
            gianhap: Number(row.gianhap || row["Gi√° nh·∫≠p"] || 0),
            giaban: Number(row.giaban || row["Gi√° b√°n"] || 0),
            ton: Number(row.ton || row["S·ªë l∆∞·ª£ng"] || 0),
            anh: ""
          });
        });
      }

      if (!Array.isArray(importedData) || importedData.length === 0) {
        throw new Error("File kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng");
      }

      if (confirm("Thay th·∫ø to√†n b·ªô d·ªØ li·ªáu hi·ªán t·∫°i?")) {
        data = importedData;
        save();
        render();
        showToast("‚úì Nh·∫≠p d·ªØ li·ªáu th√†nh c√¥ng");
      }

    } catch (err) {
      showToast("‚ö†Ô∏è L·ªói: " + err.message);
    }
  };

  if (fileName.endsWith(".xlsx")) {
    reader.readAsBinaryString(file);
  } else {
    reader.readAsText(file);
  }

  event.target.value = "";
}

function xemAnh(src) {
  document.getElementById("imgModal").style.display = "flex";
  document.getElementById("modalImg").src = src;
}

function dongImgModal() {
  document.getElementById("imgModal").style.display = "none";
}

 
render();
</script>
</body>
</html>



